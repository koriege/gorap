###########
# GORAP 2 #
###########

1   INSTALLATION
1.1 INFORMATION
1.2 INSTALLATION
1.3 HIGHLY RECOMMENDED POST INSTALLATION
2   UPDATE GORAP
2.1 UPDATE GORAP LIBRARY
2.2 UPDATE GORAP TOOLS
2.3 UPDATE GORAP DATABASES
3   RUNNING GORAP
4	RESULTS
5   KNOWN ISSUES AND SOLUTIONS
6   MISSING STUFF
7	CONTACT

--------------
1 INSTALLATION
--------------

1.1 INFORMATION

We also provide a pre-compiled, operating system independent version based on Docker
see http://www.rna.uni-jena.de/en/software/

--

GORAP will be installed in the following directory, which can be changed
during the INSTALLATION step: $HOME/gorap

GORAP requires some Perl modules. By default missing ones will be installed 
into a conventional, shared perl5 directory in your home. These modules can 
be used by other Perl scripts, too. The location can be changed during the
INSTALLATION step: $HOME/perl5

1.2 INSTALLATION

# Set the two following directories, which can be changed here
export GORAP=$HOME/gorap
export GORAPLIB=$HOME/perl5	
# Update the Perl library path
export PERL5LIB=$GORAPLIB/lib/perl5:$PERL5LIB
# Update the binaries path to make GORAP available globally
export PATH=$GORAP:$PATH
# Download GORAP latest release
wget https://github.com/rna-hta-jena/gorap/archive/v2.3.1-stable.zip -O v2.3.1-stable.zip
# Extract GORAP
unzip v2.3.1-stable.zip
# Enter extracted directory
cd gorap-2.3.1-stable
# Download corresponding databases (includes Rfam 12.0)
wget www.rna.uni-jena.de/supplements/gorap/data-12.tar.gz -O data-12.tar.gz
# Extract databases into $GORAP
tar -xzf data-12.tar.gz -C $GORAP/
# Local installation of missing software into $GORAP (for everything execute: ./install_tools.sh force)
./install_tools.sh
# Set path to necessary and always downloaded Samtools software
export SAMTOOLS=$GORAP/samtools-0.1.19
# Installation of GORAP and latest required Perl modules
wget https://cpanmin.us -O cpanm && chmod 755 cpanm
./cpanm -l $GORAPLIB .
# Mute BioPerl warnings (to restore changes execute: bash nowarnings.sh off)
bash nowarnings.sh on
# Copy all scripts to the $GORAP directory
cp *.pl $GORAP	
# you are done - go rapping!


1.3 HIGHLY RECOMMENDED POST INSTALLATION

# To use GORAP later from command line again and to be able to update it, you
# can redo all exports from INSTALLATION or store them permanently this way.
echo 'export PATH=$PATH:'$GORAP >> $HOME/.bashrc
echo 'export GORAP='$GORAP >> $HOME/.bashrc
echo 'export PERL5LIB='$PERL5LIB >> $HOME/.bashrc


--------------
2 UPDATE GORAP
--------------

This section describes how to install a newer releases of either Gorap or used databases

2.1 UPDATE GORAP LIBRARY 

# in case of a new release e.g. v2.x.x
wget https://github.com/rna-hta-jena/gorap/archive/v2.x.x-stable.zip -O v2.x.x-stable.zip -O v2.x.x-stable.zip
unzip v2.x.x-stable.zip
cd gorap-v2.x.x-stable
# make sure to have $GORAP and $GORAPLIB exported first/permanent
wget https://cpanmin.us -O cpanm && chmod 755 cpanm
./cpanm -l $GORAPLIB --reinstall .
cp *.pl $GORAP


2.2 UPDATE GORAP TOOLS

# redo
bash install_tools.sh

2.3 UPDATE GORAP DATABASES

# Update all databases or single ones by defining silva, ncbi or rfam instead
perl Gorap.pl -update all


---------------
3 RUNNING GORAP
---------------

# Hint 1: Multiple (not parallel) runs can be saved into the same output directory
# Hint 2: Restart a run with same parameters, adding -skip, skips annotation
# -> but enables additional computations like sorting and phylogeny reconstruction
# Hint 3: Command line parameters priorize parameter file settings
# -> e.g. call Gorap.pl -file parameter.txt -skip -sort -l new_label
# Hint 4: For each Rfam model in $GORAP/config exists specific configuration files
# -> Optionally set thresholds, other prediction tools and sequence mismatch constrains here
# -> see an exmample here: $GORAP/config/RF00016_SNORD14.cfg 
# -> Create an own covariance model and similar configuration file to screen for new families

# Run GORAP using a parameter file - see example parameter file for available options
perl Gorap.pl -file parameter.txt

# Run GORAP using command line parameters
perl Gorap.pl -c 8 -i $GORAP/example/ecoli.fa -a ecol -k bac -s 562 -r 543 -g $GORAP/example/ecoli.gff

# Run GORAP without taxonomy filter and reading of NCBI Taxonomy even if -s or -r are used
perl Gorap.pl -notax -c 8 -i $GORAP/example/ecoli.fa -a ecol -k bac	-s 562 -r 543

# Screen for a subset of families: ids 1 to 5, 8 and all greater equals 100
perl Gorap.pl -c 8 -i $GORAP/example/ecoli.fa -a ecol -k bac -q 1:5,8,100:
  
# Example of annotation and SSU/RNome phylogeny reconstruction in one step. 
# A given outgroup will be screened only for families present in genome files given by -i
perl Gorap.pl -i <FASTA>,<FASTA>,<FASTA>,<FASTA> -k bac -og <FASTA>
  
# 3-Step Phylogeny reconstruction from a full annotation after hand curated alignments
# we recommend to use a defined label to update related HTML page displaying results
perl Gorap.pl -i <FASTA>,<FASTA>,<FASTA>,<FASTA> -k bac -l myphylo
# Evaluate alignments by removing/adding sequences and now update annotation files
perl Gorap.pl -i <FASTA>,<FASTA>,<FASTA>,<FASTA> -k bac -refresh -l myphylo
# Skip the annotation process, but do downstream analysis i.e. phylogeny reconstruction
perl Gorap.pl -i <FASTA>,<FASTA>,<FASTA> -og <FASTA> -k bac -skip -l myphylo

# De-novo prediction and TPM/FPKM calculation from (small-)RNA-Seq experiments
perl Gorap.pl -i <FASTA>,<FASTA>,<FASTA> -k bac -b <BAM>,<BAM> 
# Hint: experimental feature. 

---------
4 RESULTS
---------

annotations: contains ncRNA predictions in GFF3 and FASTA format
	*orig - files with original sequence ids 
	*final - files with predictions passing all filter steps
	GFF tags of filtered, unreliable sequences: 
		L - Length cutoff if predicted sequence is shorter than 40% of conserved Rfam sequence
		B - Bitscore threshold of lowest score of taxonomic related species in Rfam 
			or as suggested by Rfam for family model, lowered by 10%, applied for non CD-snoRNAs
		S - Structure based rejection, if less than 50% of conserved hairpins are present
		P - Primary sequence conservation based rejection, if less than 70% bases are present
			of conserved bases in 90% of Rfam sequences
			Exception: CD-snoRNAs - which are screened for special properties and appropriate 
			box motifs as manually predefined in Rfam model specific configuration files
		C - Copy number cutoff as defined in model specific configuration files
		O - Overlap based rejection if previous, higher scoring annotation exists or is provided
		X - Tag of manually deleted sequences from alignments after Gorap.pl -refresh call
		! - Final tag - all filters passed
alignments: contains Stockholm alignments of final predictions for all screened Rfam models
meta: contains Stockholm alignments of each filter step - see GFF tags
phylogeny: containes reconstructed phylogenies of given species based on
	RNome - all ncRNA predictions except rRNAs and tRNAs, using a super-matrix approach
	core50RNome - ncRNA predictions, present in 50% of given species and except rRNAs and tRNAs,
		using a super-matrix approach
	coreRNome STK - ncRNAs present in all species, built from concatenated Stockholm alignments
	coreRNome MAFFT - ncRNAs present in all species, built by Mafft from concatenated FASTA sequences
html: contains labeled html files linking to related results, accessible via main index.html web page


----------------------------
4 KNOWN ISSUES AND SOLUTIONS
----------------------------

GORAP dies due to a Blast bug, if FASTA headers have NCBI typical accession numbers somewhere inside
>something gi|00000000|ref|NC_000000.0| something else
Transform headers into 
>gi|00000000|ref|NC_000000.0| something else
by executing

sed -i'' -e 's/^>\S*\s*/>/' file.fasta


---------------
5 MISSING STUFF
---------------

Suggestions? Bugs? Please let me know :)


---------
6 CONTACT
---------

Konstantin Riege
Chair of Bioinformatics
High Throughput Analysis
Friedrich-Schiller-University Jena
http://www.rna.uni-jena.de
konstantin{.}riege{a}uni-jena{.}de
